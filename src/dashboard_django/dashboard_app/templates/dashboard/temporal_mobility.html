{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Mobilit√© Temporelle - Dashboard CI{% endblock %}
{% block page_title %}üé¨ Mobilit√© dans le Temps{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
    #temporal-map { height: 500px; border-radius: 10px; }
    .time-slider-container {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }
    .play-controls {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
    }
    .play-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1.2rem;
    }
    #time-slider {
        flex-grow: 1;
    }
    .month-label {
        font-size: 1.5rem;
        font-weight: bold;
        color: #FF6B00;
    }
    .flow-line {
        stroke: #FF6B00;
        stroke-opacity: 0.6;
        fill: none;
    }
    .racing-bar {
        transition: all 0.5s ease-out;
    }
    #racing-chart {
        height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<!-- Contr√¥les temporels -->
<div class="time-slider-container">
    <div class="row align-items-center">
        <div class="col-md-8">
            <div class="play-controls">
                <button id="play-btn" class="btn btn-primary play-btn" onclick="togglePlay()">
                    <i class="bi bi-play-fill" id="play-icon"></i>
                </button>
                <input type="range" class="form-range" id="time-slider" min="1" max="12" value="1" onchange="updateVisualization()">
                <span class="month-label" id="current-month">Janvier</span>
            </div>
            <div class="d-flex justify-content-between small text-muted">
                <span>Jan</span><span>F√©v</span><span>Mar</span><span>Avr</span>
                <span>Mai</span><span>Juin</span><span>Juil</span><span>Ao√ªt</span>
                <span>Sep</span><span>Oct</span><span>Nov</span><span>D√©c</span>
            </div>
        </div>
        <div class="col-md-4">
            <div class="row text-center">
                <div class="col-4">
                    <h4 id="metric-flows" class="text-primary mb-0">0</h4>
                    <small class="text-muted">Flux</small>
                </div>
                <div class="col-4">
                    <h4 id="metric-movements" class="text-success mb-0">0</h4>
                    <small class="text-muted">Mouvements</small>
                </div>
                <div class="col-4">
                    <h4 id="metric-destinations" class="text-warning mb-0">0</h4>
                    <small class="text-muted">Destinations</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Onglets -->
<ul class="nav nav-tabs mb-4" id="temporalTabs" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#map-pane">üó∫Ô∏è Carte des flux</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#evolution-pane">üìà √âvolution annuelle</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#heatmap-pane">üî• Heatmap</button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#racing-pane">üèÜ Racing Chart</button>
    </li>
</ul>

<div class="tab-content">
    <!-- Carte des flux -->
    <div class="tab-pane fade show active" id="map-pane">
        <div class="card">
            <div class="card-body p-0">
                <div id="temporal-map"></div>
            </div>
            <div class="card-footer">
                <small class="text-muted">
                    üí° Les lignes repr√©sentent les corridors de mobilit√©. L'√©paisseur indique l'intensit√© du flux.
                </small>
            </div>
        </div>
    </div>
    
    <!-- √âvolution annuelle -->
    <div class="tab-pane fade" id="evolution-pane">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä √âvolution mensuelle des flux</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="evolutionChart" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">üìä Par type de migration</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="typeChart" height="250"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Heatmap -->
    <div class="tab-pane fade" id="heatmap-pane">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üî• Intensit√© des flux par destination et mois</h5>
            </div>
            <div class="card-body">
                <div id="heatmapChart" style="height: 500px;"></div>
            </div>
        </div>
    </div>
    
    <!-- Racing Bar Chart -->
    <div class="tab-pane fade" id="racing-pane">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üèÜ Course des destinations - Flux cumul√©s</h5>
            </div>
            <div class="card-body">
                <div id="racing-chart"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ===== DONN√âES =====
    // En production, ces donn√©es viendraient de l'API Django
    const localities = {
        'Abidjan': {lat: 5.36, lon: -4.01},
        'Bouak√©': {lat: 7.69, lon: -5.03},
        'Yamoussoukro': {lat: 6.82, lon: -5.28},
        'Korhogo': {lat: 9.46, lon: -5.63},
        'San-P√©dro': {lat: 4.75, lon: -6.64},
        'Daloa': {lat: 6.88, lon: -6.45},
        'Man': {lat: 7.41, lon: -7.55},
        'Gagnoa': {lat: 6.13, lon: -5.95},
        'Abengourou': {lat: 6.73, lon: -3.50},
        'Divo': {lat: 5.84, lon: -5.36},
        'Bondoukou': {lat: 8.04, lon: -2.80},
        'Odienn√©': {lat: 9.51, lon: -7.57}
    };
    
    const monthNames = ['', 'Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin',
                        'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'];
    
    // G√©n√©rer des donn√©es simul√©es pour chaque mois
    function generateMonthlyData() {
        const data = {};
        const seasonalFactors = [1.0, 0.9, 0.85, 0.8, 0.75, 0.7, 0.9, 1.0, 1.3, 1.2, 1.0, 1.4];
        
        for (let month = 1; month <= 12; month++) {
            const flows = [];
            const locs = Object.keys(localities);
            
            for (let i = 0; i < locs.length; i++) {
                for (let j = 0; j < locs.length; j++) {
                    if (i !== j) {
                        // Biais vers Abidjan
                        let weight = Math.random() * seasonalFactors[month-1] * 100;
                        if (locs[j] === 'Abidjan') weight *= 2;
                        
                        if (weight > 30) {
                            flows.push({
                                origin: locs[i],
                                destination: locs[j],
                                count: Math.floor(weight)
                            });
                        }
                    }
                }
            }
            data[month] = flows;
        }
        return data;
    }
    
    const monthlyFlows = generateMonthlyData();
    
    // ===== CARTE LEAFLET =====
    const map = L.map('temporal-map').setView([7.54, -5.55], 6);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© OpenStreetMap'
    }).addTo(map);
    
    let flowLines = [];
    let markers = [];
    
    function updateMap(month) {
        // Supprimer les √©l√©ments pr√©c√©dents
        flowLines.forEach(line => map.removeLayer(line));
        markers.forEach(marker => map.removeLayer(marker));
        flowLines = [];
        markers = [];
        
        const flows = monthlyFlows[month] || [];
        const destTotals = {};
        
        // Dessiner les lignes de flux
        flows.forEach(flow => {
            const origin = localities[flow.origin];
            const dest = localities[flow.destination];
            
            if (origin && dest) {
                const line = L.polyline(
                    [[origin.lat, origin.lon], [dest.lat, dest.lon]],
                    {
                        color: '#FF6B00',
                        weight: Math.max(1, flow.count / 20),
                        opacity: 0.5
                    }
                ).addTo(map);
                
                line.bindPopup(`${flow.origin} ‚Üí ${flow.destination}<br><b>${flow.count} flux</b>`);
                flowLines.push(line);
                
                // Accumuler les totaux par destination
                destTotals[flow.destination] = (destTotals[flow.destination] || 0) + flow.count;
            }
        });
        
        // Ajouter les marqueurs de destination
        Object.entries(destTotals).forEach(([dest, total]) => {
            const loc = localities[dest];
            if (loc) {
                const marker = L.circleMarker([loc.lat, loc.lon], {
                    radius: Math.max(8, Math.sqrt(total) / 2),
                    fillColor: '#FF6B00',
                    color: '#fff',
                    weight: 2,
                    fillOpacity: 0.8
                }).addTo(map);
                
                marker.bindPopup(`<b>${dest}</b><br>${total} flux entrants`);
                markers.push(marker);
            }
        });
        
        // Mettre √† jour les m√©triques
        const totalFlows = flows.reduce((sum, f) => sum + f.count, 0);
        document.getElementById('metric-flows').textContent = totalFlows.toLocaleString();
        document.getElementById('metric-movements').textContent = flows.length;
        document.getElementById('metric-destinations').textContent = Object.keys(destTotals).length;
    }
    
    // ===== CONTR√îLES DE LECTURE =====
    let isPlaying = false;
    let playInterval = null;
    
    function togglePlay() {
        isPlaying = !isPlaying;
        const icon = document.getElementById('play-icon');
        
        if (isPlaying) {
            icon.className = 'bi bi-pause-fill';
            playInterval = setInterval(() => {
                const slider = document.getElementById('time-slider');
                let value = parseInt(slider.value);
                value = value >= 12 ? 1 : value + 1;
                slider.value = value;
                updateVisualization();
            }, 1500); // 1.5 secondes par mois
        } else {
            icon.className = 'bi bi-play-fill';
            clearInterval(playInterval);
        }
    }
    
    function updateVisualization() {
        const month = parseInt(document.getElementById('time-slider').value);
        document.getElementById('current-month').textContent = monthNames[month];
        updateMap(month);
        updateRacingChart(month);
    }
    
    // ===== GRAPHIQUE D'√âVOLUTION =====
    const monthlyTotals = [];
    for (let m = 1; m <= 12; m++) {
        const total = (monthlyFlows[m] || []).reduce((sum, f) => sum + f.count, 0);
        monthlyTotals.push(total);
    }
    
    new Chart(document.getElementById('evolutionChart'), {
        type: 'bar',
        data: {
            labels: monthNames.slice(1),
            datasets: [{
                label: 'Flux total',
                data: monthlyTotals,
                backgroundColor: '#FF6B00',
                borderRadius: 5
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false },
                annotation: {
                    annotations: {
                        rentr√©e: {
                            type: 'label',
                            xValue: 'Septembre',
                            yValue: monthlyTotals[8],
                            content: 'üìö Rentr√©e',
                            backgroundColor: 'rgba(0,0,0,0.7)',
                            color: 'white'
                        }
                    }
                }
            }
        }
    });
    
    // ===== GRAPHIQUE PAR TYPE =====
    const types = ['Travail', '√âtudes', 'Famille', 'Commerce', 'Autre'];
    const typeData = types.map(type => {
        return monthNames.slice(1).map((_, idx) => 
            Math.floor(monthlyTotals[idx] * (0.1 + Math.random() * 0.3))
        );
    });
    
    new Chart(document.getElementById('typeChart'), {
        type: 'line',
        data: {
            labels: monthNames.slice(1),
            datasets: types.map((type, idx) => ({
                label: type,
                data: typeData[idx],
                fill: true,
                borderColor: ['#FF6B00', '#0d6efd', '#198754', '#ffc107', '#6c757d'][idx],
                backgroundColor: ['rgba(255,107,0,0.2)', 'rgba(13,110,253,0.2)', 
                                  'rgba(25,135,84,0.2)', 'rgba(255,193,7,0.2)', 
                                  'rgba(108,117,125,0.2)'][idx]
            }))
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' }
            },
            scales: {
                y: { stacked: true }
            }
        }
    });
    
    // ===== HEATMAP =====
    const heatmapData = [];
    const destinations = Object.keys(localities);
    
    destinations.forEach(dest => {
        const row = [];
        for (let m = 1; m <= 12; m++) {
            const flows = monthlyFlows[m] || [];
            const total = flows.filter(f => f.destination === dest)
                              .reduce((sum, f) => sum + f.count, 0);
            row.push(total);
        }
        heatmapData.push(row);
    });
    
    Plotly.newPlot('heatmapChart', [{
        z: heatmapData,
        x: monthNames.slice(1),
        y: destinations,
        type: 'heatmap',
        colorscale: 'YlOrRd',
        hoverongaps: false
    }], {
        margin: { l: 100, r: 20, t: 20, b: 50 }
    });
    
    // ===== RACING BAR CHART =====
    function updateRacingChart(upToMonth) {
        const cumulative = {};
        
        for (let m = 1; m <= upToMonth; m++) {
            (monthlyFlows[m] || []).forEach(flow => {
                cumulative[flow.destination] = (cumulative[flow.destination] || 0) + flow.count;
            });
        }
        
        const sorted = Object.entries(cumulative)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10);
        
        const maxValue = sorted[0] ? sorted[0][1] : 1;
        
        Plotly.react('racing-chart', [{
            type: 'bar',
            x: sorted.map(s => s[1]),
            y: sorted.map(s => s[0]),
            orientation: 'h',
            marker: {
                color: sorted.map((_, i) => i === 0 ? '#FF6B00' : '#0d6efd')
            },
            text: sorted.map(s => s[1].toLocaleString()),
            textposition: 'outside'
        }], {
            title: `Flux cumul√©s - ${monthNames[upToMonth]}`,
            xaxis: { range: [0, maxValue * 1.2] },
            yaxis: { autorange: 'reversed' },
            margin: { l: 120, r: 50, t: 50, b: 50 },
            height: 400
        });
    }
    
    // Initialisation
    updateVisualization();
</script>
{% endblock %}
